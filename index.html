<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulación con Controles - Múltiples Rutas</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: sans-serif;
      z-index: 999;
    }

    .vehicle {
      background-color: red;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      transform: translate(-7px, -7px);
    }

    .porcentaje {
      font-weight: bold;
      display: block;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- CONTROLES -->
  <div id="controls">
    <button id="playPause">⏸️ Pausar</button><br><br>
    Velocidad: <input type="range" id="speedControl" min="0.5" max="3" step="0.1" value="1"><br>
    <span class="porcentaje" id="p1">Ruta 1: 0%</span>
    <span class="porcentaje" id="p2">Ruta 2: 0%</span>
    <span class="porcentaje" id="p3">Ruta 3: 0%</span>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([25.6866, -100.3161], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const rutas = [
      [
        [25.6866, -100.3161],
        [25.6868, -100.3140],
        [25.6875, -100.3130],
        [25.6880, -100.3105],
        [25.6890, -100.3090]
      ],
      [
        [25.6866, -100.3161],
        [25.6858, -100.3175],
        [25.6845, -100.3160],
        [25.6835, -100.3135],
        [25.6828, -100.3110]
      ],
      [
        [25.6866, -100.3161],
        [25.6872, -100.3180],
        [25.6885, -100.3195],
        [25.6895, -100.3180],
        [25.6900, -100.3160]
      ]
    ];

    const colores = ['blue', 'green', 'orange'];
    const marcadores = [];
    const animaciones = [];
    const porcentajes = [0, 0, 0];
    const porcentajeIds = ['p1', 'p2', 'p3'];
    let velocidadBase = 3000;
    let pausado = false;

    rutas.forEach((ruta, index) => {
      L.polyline(ruta, {
        color: colores[index],
        weight: 4
      }).addTo(map);

      const marcador = L.marker(ruta[0], {
        icon: L.divIcon({ className: 'vehicle' })
      }).addTo(map);

      marcadores.push(marcador);
      animarRuta(index, ruta, marcador);
    });

    function animarRuta(id, coordenadas, marcador) {
      let i = 0;

      function siguienteTramo() {
        if (i >= coordenadas.length - 1) {
          i = 0;
          porcentajes[id] = 0;
        }

        const inicio = { lat: coordenadas[i][0], lng: coordenadas[i][1] };
        const fin = { lat: coordenadas[i + 1][0], lng: coordenadas[i + 1][1] };

        animaciones[id] = anime({
          targets: inicio,
          lat: fin.lat,
          lng: fin.lng,
          duration: velocidadBase,
          easing: 'linear',
          update: () => {
            marcador.setLatLng([inicio.lat, inicio.lng]);
            const progress = animaciones[id].progress / 100;
            const tramos = coordenadas.length - 1;
            porcentajes[id] = ((i + progress) / tramos * 100).toFixed(1);
            document.getElementById(porcentajeIds[id]).innerText = `Ruta ${id + 1}: ${porcentajes[id]}%`;
          },
          complete: () => {
            i++;
            siguienteTramo();
          }
        });
      }

      siguienteTramo();
    }

    // Play / Pause Global
    document.getElementById("playPause").addEventListener("click", () => {
      pausado = !pausado;
      animaciones.forEach(anim => {
        if (pausado) anim.pause();
        else anim.play();
      });
      document.getElementById("playPause").innerText = pausado ? "▶️ Reanudar" : "⏸️ Pausar";
    });

    // Control de velocidad
    document.getElementById("speedControl").addEventListener("input", (e) => {
      const factor = parseFloat(e.target.value);
      velocidadBase = 3000 / factor;

      // Reiniciar tramos con nueva velocidad
      animaciones.forEach((anim, index) => {
        if (anim) anim.pause(); // detener actual
        animarRuta(index, rutas[index], marcadores[index]); // reiniciar
      });
    });
  </script>
</body>
</html>
